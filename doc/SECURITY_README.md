# SECURITY API

## get_certificate

```javascript
String get_certificate(String cert_name, String cert_type)
```

**Description**

Return the certificate stored in the Secure Element in PEM format

**Parameters**

*String*: Certificate indentifier. Must be **ARTIK/0**

*String*: Certificate type of output. Must be **ARTIK_SECURITY_CERT_TYPE_PEM** or
 **ARTIK_SECURITY_CERT_TYPE_DER**

**Return value**

*String*: PEM certificate or error information

**Example**

```javascript
console.log(get_certificate('ARTIK/O', 'ARTIK_SECURITY_CERT_TYPE_PEM'))
```

## get_ca_chain

```javascript
String get_certificate_pem_chain(String cert_name)
```

**Description**

Return the Certificate Authority chain of the device in PEM format.
It contains one or more certificates used for verifying the device
certificate stored in the SE.

**Parameters**

*String*: Certificate identifier. Must be **ARTIK/0**

**Return value**

*String*: PEM certificate(s) or error information

**Example**

```javascript
console.log(get_certficate_pem_chain('ARTIK/O'))
```

## get_ec_publickey_from_cert

```javascript
String get_ec_publickey_from_cert(String certificate)
```

**Description**

Get EC public key from the certificate passed as parameter.

**Parameters**

*String*: String containing the certificate to retrieve the EC public key.

**Return value**

*String*: PEM private key or error information.

**Example**

```javascript
var cert = get_certificate('ARTIK/O')
console.log(get_key_from_cert(cert))
```

## get_certificate_sn

```javascript
Buffer get_certificate_sn(String cert_name)
```

**Description**

Return the serial number extracted from the device certificate
stored in the Secure Element. It is returned as a buffer of bytes.

**Parameters**

*String*: Certificate identifier. Must be **ARTIK/O**

**Return value**

*Buffer*: serial number

**Example**

```javascript
console.log(get_certificate_sn('ARTIK/O'))
```

## get_random_bytes

```javascript
Buffer get_random_bytes(Number length)
```

**Description**

Return a buffer of N bytes generated by the Secure Element.

**Parameters**

*Number*: length in bytes of the random buffer to generate.

**Return value**

*Buffer*: generated random bytes.

**Example**

```javascript
console.log(get_random_bytes(64))
```
## verify_signature_init

```javascript
verify_signature_init(String signature, String root_ca, Date signing_time, function(Number err, String reason, Date signing_time))
```

**Description**

Initialize a verification session for checking PKCS7 signature against a signed
binary.

**Parameters**

 - *String*: PKCS7 signature in PEM format
 - *String*: Root CA certificate in PEM format
 - *Date*: Signing time of the previous update package. If *Undefined* is provided
instead, no rollback detection will be performed
 - *function(Integer err, String reason, Date signing_time)*: callback function that
will be called after performing the initialization, and return result. If the function
was successful *err* will contain 0 otherwise an error code and *reason* will contain
details about the error. *signing_time* returns the signing time extracted from
the PKCS7 signature passed in parameters.

**Return value**

None.

## verify_signature_update

```javascript
verify_signature_update(Buffer data, function(Number err, String reason))
```

**Description**

Feed the verification session with data from the signed binary to check
against the PKCS7 signature. This function must be called by iterations
to feed the full content of the binary data.

**Parameters**

 - *Buffer*: buffer containing next portion of data from the signed binary
 - *function(Integer err, String reason)*: function called after processing
the data, returning the result of the operation. If the function was successful
*err* contains 0, if an error occured an error code is passed to *err* and
details can be found in the *reason* string.

**Return value**

None.

## verify_signature_final

```javascript
verify_signature_update(function(Number err, String reason))
```

**Description**

Finalize the verification session and return result.

**Parameters**

 - *function(Integer err, String reason)*: function called after performing
final verification, returning the result of the operation. If the function was
successful *err* contains 0, if an error occured an error code is passed to *err*
and details can be found in the *reason* string.

**Return value**

None.

## pkcs7_sig_verify

```javascript
pkcs7_sig_verify(String signature_file, String root_ca_file, String signed_file, String cert_id, Date signing_date, function(Object result))
```

**Description**

Perform signature verification of a binary against its PKCS7 signature.

**Parameters**

 - *String*: path to the file containing the PKCS7 signature in PEM format
 - *String*: path to the file containing the root CA file in PEM format
 - *String*: ID of the certificate from the Secure Element to use as the root CA.
 Accepted values are *'artik'*, *'manufacturer'*, or *''* (empty string) to use *root_ca_file*.
 - *Date*: signing date of the previous applied update package, used for rollback detection.
 - *function(Object result)*: object containing result information as described below:

```javascript
var result = {
    /* True if an error occured, False if verification is successful */
    error: Boolean,
    /* Details about the error */
    reason: String,
    /* Error code */
    error_code: Number,
    /* Signing time extracted from the PKCS7 signature */
    signing_time: Date,
}
```

*error_code* can be one of the following:

| Error code | Reason                          |
|:-----------|:-------------------------------:|
| 0          | success                         |
| -1         | invalid parameters              |
| -2         | invalid X509 certificate        |
| -3         | invalid PKCS7 signature         |
| -4         | CA verification failed          |
| -5         | computed digest mismatch        |
| -6         | signature verification failed   |
| -7         | signing time rollback detected  |

**Return value**

None.

**Examples**

* See [pkcs7-sig-verify.js](/examples/pkcs7-sig-verify.js)

## set_certificate

```javascript
set_certificate(String cert_name, String sample_cert)
```

**Description**

Set the certificate in secure element.

**Parameters**

 - *String*: Certificate identifier.
 - *String*: Sample Certificate.

**Return value**

*String*: Success or error information.

## remove_certificate

```javascript
remove_certificate(String cert_name)
```

**Description**

Remove a certificate in secure element.

**Parameters**

 - *String*: Certificate identifier.

**Return value**

*String*: Success or error information.

## get_hash

```javascript
get_hash(Number see_hash_mode, Buffer sample_key)
```

**Description**

Get the hash of the input message.

**Parameters**

 - *Number*: Hash algorithm.
 - *Buffer*: Input data.

**Return value**

*Buffer*: Return the hash of the input message or error information.

## generate_key

```javascript
generate_key(Number key_algorithm, String const_key_name)
```

**Description**

Generate a key

**Parameters**

 - *Number*: Key algorithm.
 - *String*: Key path and identity.

**Return value**

*String*: Return success or error information.

## get_hmac

```javascript
get_hmac(Number see_hash_mode, String hmac_key_name, Buffer sample_key)
```

**Description**

Get HMAC from input data.

**Parameters**

 - *Number*: Hash algorithm.
 - *String*: HMAC key to use.
 - *Buffer*: Input data.

**Return value**

*Buffer*: Return the hmac of the input message or error information.

## remove_key

```javascript
remove_key(Number key_algorithm, String const_key_name)
```

**Description**

Remove a key

**Parameters**

 - *Number*: Key algorithm.
 - *String*: Key path and identity.

**Return value**

*String*: Return success or error information.

## get_rsa_signature

```javascript
get_rsa_signature(Number see_rsa_mode, String rsa_key_name, Buffer hash)
```

**Description**

Get rsa signature for input data.

**Parameters**

 - *Number*: RSA algorithm. This should be in @ref see_rsa_mode define form.
 - *String*: Key_name : RSA key to use.
 - *Buffer*: Hash value. User should calculate hash value from a message.
 get_hash() might be used for it.

**Return value**

*Buffer*: Return the rsa signature or error information.

## verify_rsa_signature

```javascript
verify_rsa_signature(Number see_rsa_mode, String rsa_key_name, Buffer hash, Buffer rsa_sig)
```

**Description**

Verify rsa signature for input hash

**Parameters**

 - *Number*: RSA algorithm. This should be in @ref see_rsa_mode define form.
 - *String*: Key_name : RSA key to use.
 - *Buffer*: Hash value. User should calculate hash value from a message.
 get_hash() might be used for it.
 - *Buffer*: signature value.

**Return value**

*String*: Return success or error information.

## get_ecdsa_signature

```javascript
get_ecdsa_signature(Number see_algorithm, String ecc_key_name, Buffer hash)
```

**Description**

Get ecdsa signature for input data.

**Parameters**

 - *Number*: ECDSA algorithm.
 - *String*: ECC key to use.
 - *Buffer*: Hash value. User should calculate hash value from a message.
 get_hash() might be used for it.

**Return value**

*Buffer*: Return the ecdsa signature or error information.

## verify_ecdsa_signature

```javascript
verify_ecdsa_signature(Number see_algorithm, String ecc_key_name, Buffer hash, Buffer ecdsa_sig)
```

**Description**

Verify ecdsa signature for input hash

**Parameters**

 - *Number*: ECDSA algorithm.
 - *String*: ECC key to use.
 - *Buffer*: Hash value. User should calculate hash value from a message.
 get_hash() might be used for it.
 - *Buffer*: signature value.

**Return value**

*String*: Return success or error information.

## set_key

```javascript
set_key(Number see_algorithm, String sample_key_name, Buffer sample_key)
```

**Description**

Set a key.

**Parameters**

 - *Number*: Key algorithm.
 - *String*: Key path and identity.
 - *Buffer*: Key form is in DER.

**Return value**

*String*: Return success or error information.

## get_publickey

```javascript
get_publickey(Number see_algorithm, String sample_key_name)
```

**Description**

Get public key from an asymmetric key.

**Parameters**

 - *Number*: Key algorithm.
 - *String*: Key path and identity.
 - *Buffer*: Key form is in DER.

**Return value**

*Buffer*: Public key value. This is double pointer and will be allocated in this
function with proper size. This pointer must be freed by caller.

## write_secure_storage

```javascript
write_secure_storage(String name_storage, Number offset_storage, Buffer data_write_storage)
```

**Description**

Write a small data into secure storage.

**Parameters**

 - *String*: Data name in secure storage.
 - *Number*: Data offset.
 - *Buffer*: Allocated memory of the data.

**Return value**

*String*: Return success or error information.

## read_secure_storage

```javascript
read_secure_storage(String name_storage, Number offset_storage, Number data_read_size)
```

**Description**

Read a data from secure storage.

**Parameters**

 - *String*: Data name in secure storage.
 - *Number*: Data offset.
 - *Buffer*: The size of the read data.

**Return value**

*Buffer*: Return the read data or error information.

## remove_secure_storage

```javascript
remove_secure_storage(String name_storage)
```

**Description**

Remove a data from secure storage.

**Parameters**

 - *String*: Data name in secure storage.

**Return value**

*String*: Return success or error information.

## aes_encryption

```javascript
aes_encryption(Number see_aes_mode, String aes_key_name, Buffer iv, Buffer sample_key)
```

**Description**

Encrypt a input message using AES.

**Parameters**

 - *Number*: AES algorithm.
 - *String*: AES key path and identity.
 - *Buffer*: Initial vector value.
 - *Buffer*: Input message to be encrypted.

**Return value**

*Buffer*: Encrypted result value or error information.

## aes_decryption

```javascript
aes_decryption(Number see_aes_mode, String aes_key_name, Buffer iv, Buffer aes_enc_data)
```

**Description**

Encrypt a input message using AES.

**Parameters**

 - *Number*: AES algorithm.
 - *String*: AES key path and identity.
 - *Buffer*: Initial vector value.
 - *Buffer*: Input message to be decrypted.

**Return value**

*Buffer*: Decrypted result value or error information.

## rsa_encryption

```javascript
rsa_encryption(Number see_rsa_mode, String rsa_key_name, Buffer sample_key)
```

**Description**

Encrypt a input message using RSAES.

**Parameters**

 - *Number*: RSAES mode.
 - *String*: RSA key path and name.
 - *Buffer*: Input message to be encrypted.

**Return value**

*Buffer*: Encrypted result value or error information.


## rsa_decryption

```javascript
rsa_decryption(Number see_rsa_mode, String rsa_key_name, Buffer rsa_enc_data)
```

**Description**

Decrypt a input message using RSAES.

**Parameters**

 - *Number*: RSAES mode.
 - *String*: RSA key path and name.
 - *Buffer*:  Input message to be decrypted.

**Return value**

*Buffer*: Decrypted result value or error information.

## Convert_pem_to_der

```javascript
Convert_pem_to_der(String pem_data)
```

**Description**

Convert a certificate or a key from PEM format to DER format

**Parameters**

 - *String*: pem_data Data in PEM format.

**Return value**

*Buffer*: DER Data from the conversion into DER format or error information.

## generate_dhm_params

```javascript
generate_dhm_params(Number see_algorithm, String const_key_name)
```

**Description**

Generate DH key pair and get public key.

**Parameters**
 - *Number*: Key algorithm.
 - *String*: Key path and identity.

**Return value**

*Buffer*: Public key value in DER form or error information.

## set_dhm_params

```javascript
set_dhm_params(String const_key_name, Buffer dh_params)
```

**Description**

Generate DH key pair and get public key using user's dh parameter.

**Parameters**
 - *String*: Key path and identity.
 - *Buffer*: DH parameter p and q in DER form.

**Return value**

*Buffer*: Public key value in DER form or error information.

## compute_dhm_params

```javascript
compute_dhm_params(String const_key_name, Buffer publickey)
```

**Description**

Compute secret key from DH key and public key.

**Parameters**
 - *String*: Key path and identity.
 - *Buffer*: Public key value.

**Return value**

*Buffer*: Secret key value or error information.

## generate_ecdh_params

```javascript
generate_ecdh_params(Number see_algorithm, String const_key_name)
```

**Description**

Generate ECDH key.

**Parameters**
 - *Number*: ECDH algorithm.
 - *String*: Key path and identity.

**Return value**

*Buffer*: Public key value in DER form or error information.

## compute_ecdh_params

```javascript
generate_ecdh_params(Number see_algorithm, String const_key_name)
```

**Description**

Compute secret key from ECDH key and public key.

**Parameters**
 - *String*: Key path and identity.
 - *Buffer*: Public key value.

**Return value**

*Buffer*: Secret key value or error information.